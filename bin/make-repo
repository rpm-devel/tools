#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 202202011344-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.pro
# @License       : WTFPL
# @ReadME        : make-repo --help
# @Copyright     : Copyright: (c) 2022 Jason Hempstead, Casjays Developments
# @Created       : Tuesday, Feb 01, 2022 13:44 EST
# @File          : make-repo
# @Description   : RPM release script
# @TODO          :
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="$(basename "$0")"
VERSION="202202011344-git"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
SRC_DIR="${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set bash options
if [[ "$1" == "--debug" ]]; then shift 1 && set -xo pipefail && export SCRIPT_OPTS="--debug" && export _DEBUG="on"; fi
trap 'exitCode=${exitCode:-$?};[ -n "$MAKE_REPO_TEMP_FILE" ] && [ -f "$MAKE_REPO_TEMP_FILE" ] && rm -Rf "$MAKE_REPO_TEMP_FILE" &>/dev/null' EXIT
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ "$1" = "update" ]; then
  bash -c "$(curl -q -LSsf "https://github.com/rpm-devel/tools/raw/main/install.sh")"
  exit $?
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
VERNAME="el"
DISTRO="RHEL"
ARCH="$(uname -m)"
VERNUM="$(grep -s ^'VERSION=' /etc/os-release 2>/dev/null | awk -F= '{print $2}' | sed 's|"||g' | tr ' ' '\n' | grep '[0-9]' | awk -F '.' '{print $1}' | grep '^' || echo "")"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Local FTP server address
FTPDOM="ftp.casjaysdev.pro"
FTPDIR="/var/ftp/pub/Casjay/repo"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sourceforge Web urls
SFWEB="web.sourceforge.net"
SFFRS="frs.sourceforge.net"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Developnment project name
SFPROJ="rpm-devel"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Usernames
SFUSER="${SFUSER:-}"
LOCUSER="${LOCUSER:-root}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Directories
SRCDIR="$HOME/Documents/rpmbuild/$DISTRO/$VERNAME$VERNUM/$ARCH"
TARGETDIR="$HOME/Documents/sourceforge/$DISTRO/$VERNAME$VERNUM/$ARCH"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Clean from previous builds
echo "Cleaning Previous builds"
rm -Rf "$TARGETDIR"/{srpms,rpms,debug}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Make Directories
echo "Creating Directories"
mkdir -p "$TARGETDIR"/{addons,extras,srpms,debug,rpms}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sign Packages
echo "Signing the Packages"
rpm --addsign --quiet "$SRCDIR"/*/*.rpm "$SRCDIR"/*/*/*.rpm
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Move RPMs to appropriate Directories
echo "Moving SRPMS"
rsync --no-motd -aqhP --delete "$SRCDIR"/srpm/*.rpm "$TARGETDIR/srpms/"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
echo "Moving Debug RPMS"
rsync --no-motd -aqhP "$SRCDIR"/rpms/*/*debugsource*.rpm "$TARGETDIR/debug/"
rsync --no-motd -aqhP "$SRCDIR"/rpms/*/*debuginfo*.rpm "$TARGETDIR/debug/"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
echo "Moving RPMS"
rsync --no-motd -aqhP --delete --exclude=*debuginfo* --exclude=*debugsource* "$SRCDIR"/rpms/*/*.rpm "$TARGETDIR/rpms/"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Create repos
if [ -d "$TARGETDIR/addons" ]; then
  echo "Generating Addons REPO"
  cd "$TARGETDIR/addons" && createrepo -q -d ./
fi
if [ -d "$TARGETDIR/extras" ]; then
  echo "Generating Extras REPO"
  cd "$TARGETDIR/extras" && createrepo -q -d ./
fi
if [ -d "$TARGETDIR/srpms" ]; then
  echo "Generating SRPMS REPO"
  cd "$TARGETDIR/srpms" && createrepo -q -d ./
fi
if [ -d "$TARGETDIR/debug" ]; then
  echo "Generating DEBUG REPO"
  cd "$TARGETDIR/debug" && createrepo -q -d ./
fi
if [ -d "$TARGETDIR/rpms" ]; then
  echo "Generating RPMS REPO"
  cd "$TARGETDIR/rpms" && createrepo -q -d ./
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sync to locale FTP Server
if [ -n "$LOCUSER" ] && curl -q -LSsf -I "ftp://$FTPDOM" &>/dev/null; then
  echo "Sending Locally: $LOCUSER@$FTPDOM:$FTPDIR/$DISTRO/$ARCH/$VERNUM"
  rsync --no-motd -aqhP -e ssh --chown=ftp:ftp --exclude=srpms,debug,rpms "$TARGETDIR"/* $LOCUSER@$FTPDOM:$FTPDIR/$DISTRO/$VERNUM/$ARCH
  rsync --no-motd -aqhP -e ssh --chown=ftp:ftp --delete --exclude=addons,extras "$TARGETDIR"/* $LOCUSER@$FTPDOM:$FTPDIR/$DISTRO/$VERNUM/$ARCH
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sync to website
if [ -z "$SFUSER" ]; then
  echo "The variable SFUSER need to be set to your sourceforge user"
else
  echo "$SFUSER is Sending to website: /home/project-web/$SFPROJ/htdocs/repo/$DISTRO/$VERNUM/$ARCH"
  rsync --no-motd -aqhP -e ssh --exclude=srpms,debug,rpms "$TARGETDIR"/* $SFUSER@$SFWEB:/home/project-web/$SFPROJ/htdocs/repo/$DISTRO/$VERNUM/$ARCH
  rsync --no-motd -aqhP -e ssh --delete --exclude=addons,extras "$TARGETDIR"/* $SFUSER@$SFWEB:/home/project-web/$SFPROJ/htdocs/repo/$DISTRO/$VERNUM/$ARCH
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sync to frs.sourceforge.net
if [ -z "$SFUSER" ]; then
  echo "The variable SFUSER need to be set to your sourceforge user"
else
  echo "$SFUSER is Sending to FRS site: /home/frs/project/$SFPROJ/$DISTRO/$VERNUM/$ARCH"
  rsync --no-motd -aqhP -e ssh --exclude=srpms,debug,rpms "$TARGETDIR"/* $SFUSER@$SFFRS:/home/frs/project/$SFPROJ/$DISTRO/$VERNUM/$ARCH
  rsync --no-motd -aqhP -e ssh --delete --exclude=addons,extras "$TARGETDIR"/* $SFUSER@$SFFRS:/home/frs/project/$SFPROJ/$DISTRO/$VERNUM/$ARCH
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
echo "The script has completed"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end
